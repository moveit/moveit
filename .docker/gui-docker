#!/usr/bin/env bash

# This script is used to run a docker container with an NVIDIA runtime.
# It requires the package nvidia-docker2 to be installed on the host.
# https://github.com/NVIDIA/nvidia-docker/wiki
# http://wiki.ros.org/docker/Tutorials/Hardware%20Acceleration#nvidia-docker2

# All arguments to this script will be appended to a docker run command.
# Example command line:
# ./gui-docker -it --rm moveit/moveit:master-source /bin/bash

# store X11 access rights in temp file
XAUTH=/tmp/.docker.xauth
touch $XAUTH
xauth nlist $DISPLAY | sed -e 's/^..../ffff/' | xauth -f $XAUTH nmerge -

# Set docker runtime: if you have an NVIDIA card and nvidia-docker2 installed, nvidia is fine
# Otherwise use the default runc
RUNTIME=${RUNTIME:-nvidia}

docker run \
    --env="NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}" \
    --env="NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:+$NVIDIA_DRIVER_CAPABILITIES,}graphics" \
    --env="DISPLAY=$DISPLAY" \
    --env="QT_X11_NO_MITSHM=1" \
    --env="XAUTHORITY=$XAUTH" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    --volume="$XAUTH:$XAUTH" \
    --runtime=$RUNTIME \
    $@

# cleanup
rm $XAUTH
